<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload Form</title>
   <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

</head>
<body>
<h1>Welcome To Django Charm</h1>

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

     <label for="item_code">Item Code:</label><br>
    <input type="text" name="item_code"><br><br>

    <label for="item_name">Item  Name:</label><br>
    <input type="text" name="item_name"><br><br>

    <label for="stock_qty">Stock Qty:</label><br>
    <input type="number" name="stock_qty"><br><br>

    <button type="submit">Submit</button>

</form>
<form method="POST" enctype="multipart/form-data" action="{% url 'process_final_scan' %}">
    {% csrf_token %}
<button type="submit">Scan QR</button>
</form>


{% if contract_no %}
<p>{{ contract_no }}</p>
{% endif %}
{% if party_name %}
<p>{{ party_name }}</p>
<p>{{ scanned_value }}</p>
{% endif %}





{% if items_with_qr %}
<h1>These are all Items:</h1>
{% for entry in items_with_qr %}
    <p>Item Code: {{ entry.item.item_code }}</p>
    <p>Item Name: {{ entry.item.item_name }}</p>
    <p>Item Sl: {{ entry.sl_no }}</p>

    <p> Total Stock Qty: {{ entry.item.stock_qty }}</p>
    <img src="data:image/png;base64,{{ entry.qr_code }}" alt="QR Code">
    <p>_______________________________</p>
{% endfor %}
{% endif %}

<h2>Scan QR Code</h2>
<div id="qr-reader" style="width:300px;"></div>
<p id="qr-result"></p>



<div id="user_input" style="display:none;">
<h2>User Input</h2>

<!--<form method="POST" enctype="multipart/form-data" action="{%  url 'process_final_scan' %}">-->
<!--    {% csrf_token %}-->

<!--     <label for="contract_no">Contract No:</label><br>-->
<!--    <input type="text" name="contract_no"><br><br>-->

<!--    <label for="party_name">Party Name:</label><br>-->
<!--    <input type="text" name="party_name"><br><br>-->
<!--    <button type="submit">Submit</button>-->

<!--</form>-->
    <form method="POST" enctype="multipart/form-data" action="{% url 'process_final_scan' %}">
    {% csrf_token %}

    <!-- Hidden field to hold scanned QR value -->
    <input type="hidden" name="scanned_data" id="scanned_data">

    <label for="contract_no">Contract No:</label><br>
    <input type="text" name="contract_no" required><br><br>

    <label for="party_name">Party Name:</label><br>
    <input type="text" name="party_name" required><br><br>

    <button type="submit">Submit</button>
</form>


</div>
<script>
    function onScanSuccess(decodedText, decodedResult) {
        document.getElementById("user_input").style.display = "block";
        console.log(`Code scanned = ${decodedText}`);
        document.getElementById("qr-result").innerText = "Scanned: " + decodedText;
        document.getElementById("scanned_data").value = decodedText;


        // Optionally send this to your Django view
        fetch("/process-scan/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ scanned_data: decodedText }),
        })
        .then(response => response.json())
        .then(data => console.log(data))
        .catch(error => console.error("Error:", error));
    }

    function onScanFailure(error) {
        // You can ignore scan errors, they happen when no QR code is in front of camera
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);

</script>

</body>
</html>
